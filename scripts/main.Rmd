```{r, echo=FALSE, include=FALSE}
#install.packages("viridis")
#install.packages("corrplot")
library(dplyr)
library(ggplot2)
library(viridis)
library(corrplot)
```

# Baza danych
  Baza danych **AutoSprzedam.dat**. Baza pochodzi z zasobów zgormadzonych na ePortalu.

## Zawartość
  Baza danych zawiera 41034 rekordów zawierających szczegółowe dane dotyczące sprzedaży samochodów m.in.

  <p style="text-align:center;">
  | Kolumna            | Typ danych | Opis                                                                                      |
  |--------------------|------------|-------------------------------------------------------------------------------------------|
  | NrOferty           | int        | Numer oferty sprzedaży samochodu.                                                        |
  | CenaPLN            | string      | Cena samochodu wyrażona w polskich złotych (PLN).                                         |
  | KM                 | int        | Liczba koni mechanicznych samochodu.                                                      |
  | Marka              | string     | Marka samochodu.                                                                          |
  | Model              | string     | Model samochodu.                                                                          |
  | LiczbaDrzwi       | string        | Liczba drzwi w samochodzie.                                                               |
  | PojemnoscSkokowa  | int      | Pojemność skokowa silnika wyrażona w centymetrach sześciennych (cm³).                      |
  | PrzebiegKm         | int        | Przebieg samochodu wyrażony w kilometrach.                                                |
  | RodzajPaliwa      | string     | Rodzaj paliwa używanego przez samochód (benzyna, diesel, hybryda, elektryczny itp.).      |
  | RokProdukcji       | int        | Rok produkcji samochodu.                                                                  |
  | Kolor              | string     | Kolor samochodu.                                                                          |
  | KrajPochodzenia    | string     | Kraj pochodzenia samochodu.                                                               |
  | PojazdUszkodzony  | string       | Informacja czy pojazd jest uszkodzony (Tak/Nie).                                           |
  | SkrzyniaBiegow     | string     | Typ skrzyni biegów w samochodzie (manualna, automatyczna).                                  |
  </p>
  
## Podstawowe dana dotyczące bazy danych
```{r, echo=FALSE, include=TRUE}
database = read.csv("../database/AutoSprzedam.dat", sep = "\t", dec = ',');
N = 5;
cat("Liczba rekordów:", nrow(database), ", liczba kolumn:", ncol(database), "\n\n")

cat("-", "Przykład ", N, "pierwszych rekordów.\n")
head(database, N);
cat("- ", "Przykład ", N, "ostatnich rekordów.\n")
tail(database, N);
```

# Przygotowanie bazy danych
  Przed przejściem do dalszej pracy z bazą danych konieczne jest jej przygotowanie.

## Pole - *SkrzyniaBiegow*
  W bazie występują 3 rodzaje typów skrzyni biegów: *półautomatyczna/sekwencyjna*, *manualna* oraz *automatyczna*.
  Udział typu *półautomatyczna/sekwencyjna* w całej bazie wynosi 1,5%.
  
  W związku z niewielkim udziałem ze skrzynią *półautomatyczna/sekwencyjna*, typ ten został usunięty z bazy. 
  Dzięki czemu możliwe jest przekształcenie kolumny *SkrzyniaBiegow* (char), na *SkrzyniaBiegowManualna* (bool).
```{r, echo=FALSE, include=TRUE}
gear_box_summary = database %>% group_by(database$SkrzyniaBiegow) %>% summarise(liczba = n());
gear_box_summary
cat("Udział pojazdów ze skrzynią biegów typu 'półautomatyczna/sekwencyjna'", sum(gear_box_summary[3,2])/sum(gear_box_summary[,2])*100, "%.");

# Remove cars with database$SkrzyniaBiegow == 'półautomatyczna/sekwencyjna'
database = database[database$SkrzyniaBiegow != "półautomatyczna/sekwencyjna",];

# Cast to logical value
database$SkrzyniaBiegow = database$SkrzyniaBiegow == "manualna";
colnames(database)[14] = "SkrzyniaBiegowManualna";
```
## Pole *PojazdUszkodzony*
  Domyślnym typem danych dla pola *PojazdUszkodzony* jest (char), gdzie zmienna jest typem logicznym.
  W związku z powyższym kolumna *PojazdUszkodzony* została przekształcona to typu *bool*.
```{r, echo=FALSE, include=TRUE}
database$PojazdUszkodzony = database$PojazdUszkodzony == "Tak"
```

## Baza danych po wprowadzonych modyfikacjach
```{r, echo=FALSE, include=TRUE}
cat("Baza danych po wprowadzonych modyfikacjach");
cat("Liczba rekordów:", nrow(database), ", liczba kolumn:", ncol(database), "\n\n");
cat("-", "Przykład ", N, "pierwszych rekordów.\n");
head(database, N);
cat("-", "Przykład ", N, "ostatnich rekordów.\n");
tail(database, N);
```


# Wyznaczenie podstawowych statystyk

## Pole *CenaPLN*
  Kolumna zawiera informacje o cenie po jakie asmochody zostału sprzedane w PLN.
  

### Dane przed eliminacją danych odstających
```{r}
summarise(database,
  srednia = mean(CenaPLN),
  mediana = median(CenaPLN),
  wariancja = var(CenaPLN),
  odchylenieStd = sd(CenaPLN),
  max = max(CenaPLN),
  min = min(CenaPLN),
)

ggplot(data=database) + geom_histogram(aes(x=CenaPLN), bins = 50) + ggtitle("Histogram dla cen sprzedaży");

ggplot(data=database) + geom_boxplot(aes(x=CenaPLN)) + ggtitle("Wykres pudełko-wąsy dla cen sprzedaży");

ggplot(data=database, aes(sample = CenaPLN)) + stat_qq() + stat_qq_line(colour="red") + ylab("Kwantyl Teoretyczny") + xlab("Kwantyl Empiryczny") + 
  ggtitle("Wykres QQ dla cen sprzedaży") + theme(axis.text.x = element_blank(), axis.text.y = element_blank()) ;
```
### Redukcja danych odstających
Redukcja danych zgodnie z regółą 3 sigma. 

Identyfikacja danych odstających za pomocą reguły trzech sigm:

1. Obliczenie średniej (μ): Najpierw oblicza się średnią dla danego zbioru danych.

2. Obliczenie odchylenia standardowego (σ): Następnie oblicza się odchylenie standardowe, które mierzy, jak bardzo dane rozpraszają się wokół średniej.

3. Ustalenie zakresu trzech sigm: Wartości, które znajdują się poza zakresem trzech sigm (μ ± 3σ), są uznawane za dane odstające.

```{r}
mean_price = mean(database$CenaPLN);
sd_price   = sd(database$CenaPLN);

lower_bound <- mean_price - 3 * sd_price;
upper_bound <- mean_price + 3 * sd_price;

cat("Wyznacznowe granice metodą 3 sigma \n")
cat("Dolna granica ", lower_bound, ", górna granica ", upper_bound, "\n");
cat("Dolna granica wykracza poza osiągane wartości kwot sprzedaży (ujemna wartość). \n")

upper_price_example = database[which(database$CenaPLN >= upper_bound),];
head(upper_price_example[order(upper_price_example$CenaPLN, decreasing = TRUE),])

database = database[database$CenaPLN >= lower_bound & database$CenaPLN <= upper_bound,]
```

```{r}
database %>% group_by(Marka) %>% summarise(liczbaSprzedanych = n(), 
                                                    sredniaCena = mean(CenaPLN),
                                                    medianaCena = median(CenaPLN))
```

### Dane po eliminacją danych odstających
```{r}
summarise(database,
  srednia = mean(CenaPLN),
  mediana = median(CenaPLN),
  wariancja = var(CenaPLN),
  odchylenieStd = sd(CenaPLN),
  max = max(CenaPLN),
  min = min(CenaPLN),
)

ggplot(data=database) + geom_histogram(aes(x=CenaPLN), bins = 50) + ggtitle("Histogram dla cen sprzedaży");

ggplot(data=database) + geom_boxplot(aes(x=CenaPLN)) + ggtitle("Wykres pudełko-wąsy dla cen sprzedaży");

ggplot(data=database, aes(sample = CenaPLN)) + stat_qq() + stat_qq_line(colour="red") + ylab("Kwantyl Teoretyczny") + xlab("Kwantyl Empiryczny") + 
  ggtitle("Wykres QQ dla cen sprzedaży") + theme(axis.text.x = element_blank(), axis.text.y = element_blank()) ;
```


```{r}
fuelType = database %>% group_by(database$RodzajPaliwa) %>% summarise(liczba = n());
colnames(fuelType) = c("FuelType", "Count");
fuelType = fuelType[order(fuelType$Count, decreasing = TRUE),]
fuelType

ggplot(fuelType, aes(x="", y=Count, fill=FuelType)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) + theme_void();
```
## Liczba koni mechanicznych samochodu


```{r}
summarise(database,
  srednia = mean(KM),
  mediana = median(KM),
  wariancja = var(KM),
  odchylenieStd = sd(KM),
  max = max(KM),
  min = min(KM),
)

upper_price_example = database[which(database$CenaPLN >= upper_bound),];
head(upper_price_example[order(upper_price_example$CenaPLN, decreasing = TRUE),])

ggplot(data=database)+ geom_histogram(aes(x=KM), binwidth = 20) + ggtitle("Histogram dla KM")


```

# VI - Budowa macierzy z bazy danych
Do zbudowanie macierzy wykorzystano wszystkie dostępne numeryczne dane tj. *CenaPLN*, *KM*, *PrzebiegKm*, *RokProdukcji*, *PojemnoscSkokowa*. 
Dzięki temu możliwe jest wyznaczenie macierzy korelacji pomiędzy danymi.
```{r}
# Select data
vi_database = select(filter(database, PojazdUszkodzony==FALSE & SkrzyniaBiegowManualna == TRUE), 
                     c("CenaPLN", "KM", "PrzebiegKm", "RokProdukcji", "PojemnoscSkokowa"))

#Display head
head(vi_database) 

# Dimension
vi_dim <- dim(vi_database);
cat("Rozmiar macierzy:", vi_dim[1], "x", vi_dim[2]);

# Columns mean
vi_means = round(colMeans(vi_database), 3);
cat(paste(names(vi_means), vi_means, sep = " : ", collapse = ",\n"))

# Correlation 
vi_corr_matrix = cor(vi_database);
print(vi_corr_matrix)
corrplot(vi_corr_matrix, order = "hclust", 
         tl.col = "black", tl.srt = 45)
```
Jak można zaobserwować:
- *CenaPLN* skorelowana jest z *RokProdukcji* (silnie), *KM*, *PojemnoscSkokowa* oraz odwrotnie z *PrzebiegKM*,  
- *PojemnoscSkokowa* jest silnie skorelowana z ilością *KM* (większa pojemność -> więcej KM),
- *PrzebiegKM* jest odwrotnie skorelowany z *RokProdukcji* (starszy samochód -> większy przebieg).

# VII - Przedziały ufności
```{r}
# Data
vii_price = database$CenaPLN;

# Basic statistics
vii_price_mean = mean(vii_price);
vii_price_sd = sd(vii_price);
n = length(vii_price);

# Mean confidence function
mean_confidence <- function(mean, sd, n, confidence_level) {
  alpha = 1 - confidence_level;
  offset = qnorm(1 - alpha / 2) * sd / sqrt(n);
  lower_bound = mean - offset;
  upper_bound = mean + offset;
  return(c(lower_bound, upper_bound));
};

# Confidence level 0.9, 0.95, 0.99
confidence_level = c(0.9, 0.95, 0.99);

mean_confidence_intervals = sapply(confidence_level, function(conf_level) {
  mean_confidence(vii_price_mean, vii_price_sd, n, conf_level)
});

# Create matrix
mean_confidence_intervals = t(mean_confidence_intervals);
rownames(mean_confidence_intervals) = paste0("Poziom ufności: ", confidence_level);
colnames(mean_confidence_intervals) = c("Dolny przedział", "Górny przedział");

# Display
print("Przedziały ufności średniej dla różnych poziomów ufności:");
print(mean_confidence_intervals);


# SD confidence function
sd_confidence <- function(mean, n, confidence_level) {
  alpha = 1 - confidence_level;
  offset = qnorm(1 - alpha / 2) / sqrt(2*n);
  lower_bound = mean / (1 + offset);
  upper_bound = mean / (1 - offset);
  return(c(lower_bound, upper_bound));
};

sd_confidence_intervals = sapply(confidence_level, function(conf_level) {
  sd_confidence(vii_price_mean, n, conf_level);
});

# Create matrix
sd_confidence_intervals = t(sd_confidence_intervals);
rownames(sd_confidence_intervals) = paste0("Poziom ufności: ", confidence_level);
colnames(sd_confidence_intervals) = c("Dolny przedział", "Górny przedział");

# Display
print("Przedziały ufności odchylenia standardowego dla różnych poziomów ufności:");
print(sd_confidence_intervals);
```

## Przedział ufności dla rozkładu Bernoulliego
```{r}
vii_positive = sum(database$PojazdUszkodzony == TRUE);
vii_all      = length(database$PojazdUszkodzony);

mean_bool_confidence <- function(m, n, confidence_level) {
  alpha = 1 - confidence_level;
  mn = m / n;
  offset = qnorm(1 - alpha / 2) * sqrt(mn * (1-mn)) / sqrt(n);
  lower_bound = mn - offset;
  upper_bound = mn + offset;
  return(c(lower_bound, upper_bound));
};

# Confidence level 0.9, 0.95, 0.99
confidence_level = c(0.9, 0.95, 0.99);

confidence_intervals = sapply(confidence_level, function(conf_level) {
  mean_bool_confidence(vii_positive, vii_all, conf_level);
});

# Create matrix
confidence_intervals = t(confidence_intervals);
rownames(confidence_intervals) = paste0("Poziom ufności: ", confidence_level);
colnames(confidence_intervals) = c("Dolny przedział", "Górny przedział");

# Display
print("Przedziały ufności dla frakcjidla różnych poziomów ufności (Udział pojazdów uszkodzonych):");
print(confidence_intervals);
```