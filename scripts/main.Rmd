```{r, echo=FALSE, include=FALSE}
#install.packages("viridis")
#install.packages("moments")
library(dplyr)
library(ggplot2)
library(viridis)
library(moments)
library(psych)
library(moments)
```

# Baza danych
  Baza danych **AutoSprzedam.dat**. Baza pochodzi z zasobów zgormadzonych na ePortalu.

## Zawartość
  Baza danych zawiera 41034 rekordów zawierających szczegółowe dane dotyczące sprzedaży samochodów m.in.

  <p style="text-align:center;">
  | Kolumna            | Typ danych | Opis                                                                                      |
  |--------------------|------------|-------------------------------------------------------------------------------------------|
  | NrOferty           | int        | Numer oferty sprzedaży samochodu.                                                        |
  | CenaPLN            | string      | Cena samochodu wyrażona w polskich złotych (PLN).                                         |
  | KM                 | int        | Liczba koni mechanicznych samochodu.                                                      |
  | Marka              | string     | Marka samochodu.                                                                          |
  | Model              | string     | Model samochodu.                                                                          |
  | LiczbaDrzwi       | string        | Liczba drzwi w samochodzie.                                                               |
  | PojemnoscSkokowa  | int      | Pojemność skokowa silnika wyrażona w centymetrach sześciennych (cm³).                      |
  | PrzebiegKm         | int        | Przebieg samochodu wyrażony w kilometrach.                                                |
  | RodzajPaliwa      | string     | Rodzaj paliwa używanego przez samochód (benzyna, diesel, hybryda, elektryczny itp.).      |
  | RokProdukcji       | int        | Rok produkcji samochodu.                                                                  |
  | Kolor              | string     | Kolor samochodu.                                                                          |
  | KrajPochodzenia    | string     | Kraj pochodzenia samochodu.                                                               |
  | PojazdUszkodzony  | string       | Informacja czy pojazd jest uszkodzony (Tak/Nie).                                           |
  | SkrzyniaBiegow     | string     | Typ skrzyni biegów w samochodzie (manualna, automatyczna).                                  |
  </p>
  
## Podstawowe dana dotyczące bazy danych
```{r, echo=FALSE, include=TRUE}
database = read.csv("../database/AutoSprzedam.dat", sep = "\t", dec = ',');
N = 5;
cat("Liczba rekordów:", nrow(database), ", liczba kolumn:", ncol(database), "\n\n")

cat("-", "Przykład ", N, "pierwszych rekordów.\n")
head(database, N);
cat("- ", "Przykład ", N, "ostatnich rekordów.\n")
tail(database, N);
```

# Przygotowanie bazy danych
  Przed przejściem do dalszej pracy z bazą danych konieczne jest ich przygotowanie.

## Pole - *SkrzyniaBiegow*
  W bazie występują 3 rodzaje typów skrzyni biegów: *półautomatyczna/sekwencyjna*, *manualna* oraz *automatyczna*.
  Udział typu *półautomatyczna/sekwencyjna* w całej bazie wynosi 1,5%.
  
  W związku z niewielkim udziałem ze skrzynią *półautomatyczna/sekwencyjna*, typ ten został usunięty z bazy. 
  Dzięki czemu możliwe jest przekształcenie kolumny *SkrzyniaBiegow* (char), na *SkrzyniaBiegowManualna* (bool).
```{r, echo=FALSE, include=TRUE}
gear_box_summary = database %>% group_by(database$SkrzyniaBiegow) %>% summarise(liczba = n());
gear_box_summary
cat("Udział pojazdów ze skrzynią biegów typu 'półautomatyczna/sekwencyjna'", sum(gear_box_summary[3,2])/sum(gear_box_summary[,2])*100, "%.");

# Remove cars with database$SkrzyniaBiegow == 'półautomatyczna/sekwencyjna'
database = database[database$SkrzyniaBiegow != "półautomatyczna/sekwencyjna",];

# Cast to logical value
database$SkrzyniaBiegow = database$SkrzyniaBiegow == "manualna";
colnames(database)[14] = "SkrzyniaBiegowManualna";
```
## Pole *PojazdUszkodzony*
  Domyślnym typem danych dla pola *PojazdUszkodzony* jest (char), gdzie zmienna jest typem logicznym.
  W związku z powyższym kolumna *PojazdUszkodzony* została przekształcona to typu *bool*.
```{r, echo=FALSE, include=TRUE}
database$PojazdUszkodzony = database$PojazdUszkodzony == "Tak"
```

## Baza danych po wprowadzonych modyfikacjach
```{r, echo=FALSE, include=TRUE}
cat("Baza danych po wprowadzonych modyfikacjach");
cat("Liczba rekordów:", nrow(database), ", liczba kolumn:", ncol(database), "\n\n");
cat("-", "Przykład ", N, "pierwszych rekordów.\n");
head(database, N);
cat("-", "Przykład ", N, "ostatnich rekordów.\n");
tail(database, N);
```


# Wyznaczenie podstawowych statystyk

```{r}
stats <- function(x){
  c(
    mean(x),                # średnia arytmetyczna
    harmonic.mean(x),       # średnia harmoniczna
    exp(mean(log(x))),      # średnia geometryczna
    quantile(x, 0.25)->q1,  # pierwszy kwartyl
    quantile(x, 0.5),       # mediana
    quantile(x, 0.75)->q3,  # trzeci kwartyl
    q3-q1,                  # rozstęp międzykwartylowy
    max(x)-min(x),          # rozstęp
    var(x),                 # wariancja
    sqrt(var(x)),           # odchylenie standardowe
    sqrt(var(x))/mean(x),   # współczynnik zmienności
    skewness(x),            # współczynnik skośności
    kurtosis(x),            # kurtoza
    max(x),                 # wartosc maksymalna
    min(x)                  # wartosc minimalna
  )
}

StatsNames <- c("Średnia arytmetyczna", "Średnia harmoniczna", "Średnia geometryczna", "Pierwszy kwartyl",
                "Mediana", "Trzeci kwartyl", "Rozstęp międzykwartylowy", "Rozstęp", "Wariancja",
                "Odchylenie standardowe", "Współczynnik zmienności", "Współczynnik skośności", "Kurtoza", "Max", "Min");

numerical_statistics <- data.frame("Statystyki" = StatsNames, 
           "Cena" = stats(database$CenaPLN), 
           "KM" = stats(database$KM), 
           "Pojemność" = stats(database$PojemnoscSkokowa), 
           "Przebieg" = stats(database$CenaPLN),
           "RokProdukcji"= stats(database$RokProdukcji));

numerical_statistics
```


## Pole *CenaPLN*
  Kolumna zawiera informacje o cenie po jakie asmochody zostału sprzedane w PLN.
  
### Dane  




## Cena sprzedaży

### Dane przed eliminacją danych odstających
```{r}
 

ggplot(data=database) + geom_histogram(aes(x=CenaPLN), bins = 50) + ggtitle("Histogram dla cen sprzedaży");

ggplot(data=database) + geom_boxplot(aes(x=CenaPLN)) + ggtitle("Wykres pudełko-wąsy dla cen sprzedaży");

ggplot(data=database, aes(sample = CenaPLN)) + stat_qq() + stat_qq_line(colour="red") + ylab("Kwantyl Teoretyczny") + xlab("Kwantyl Empiryczny") + 
  ggtitle("Wykres QQ dla cen sprzedaży") + theme(axis.text.x = element_blank(), axis.text.y = element_blank()) ;
```
### Redukcja danych odstających
Redukcja danych zgodnie z regółą 3 sigma. 

Identyfikacja danych odstających za pomocą reguły trzech sigm:

1. Obliczenie średniej (μ): Najpierw oblicza się średnią dla danego zbioru danych.

2. Obliczenie odchylenia standardowego (σ): Następnie oblicza się odchylenie standardowe, które mierzy, jak bardzo dane rozpraszają się wokół średniej.

3. Ustalenie zakresu trzech sigm: Wartości, które znajdują się poza zakresem trzech sigm (μ ± 3σ), są uznawane za dane odstające.

```{r}
mean_price = mean(database$CenaPLN);
sd_price   = sd(database$CenaPLN);

lower_bound <- mean_price - 3 * sd_price;
upper_bound <- mean_price + 3 * sd_price;

cat("Wyznacznowe granice metodą 3 sigma")
cat("Dolna granica ", lower_bound, ", górna granica ", upper_bound);

upper_price_example = database[which(database$CenaPLN >= upper_bound),];
head(upper_price_example[order(upper_price_example$CenaPLN, decreasing = TRUE),])

database = database[database$CenaPLN >= lower_bound & database$CenaPLN <= upper_bound,]
```
Dolna granica wykracza poza osiągane wartości kwot sprzedaży (ujemna wartość).
### Dane po eliminacją danych odstających
```{r}
summarise(database,
  srednia = mean(CenaPLN),
  mediana = median(CenaPLN),
  wariancja = var(CenaPLN),
  odchylenieStd = sd(CenaPLN),
  max = max(CenaPLN),
  min = min(CenaPLN),
)

ggplot(data=database) + geom_histogram(aes(x=CenaPLN), bins = 50) + ggtitle("Histogram dla cen sprzedaży");

ggplot(data=database) + geom_boxplot(aes(x=CenaPLN)) + ggtitle("Wykres pudełko-wąsy dla cen sprzedaży");

ggplot(data=database, aes(sample = CenaPLN)) + stat_qq() + stat_qq_line(colour="red") + ylab("Kwantyl Teoretyczny") + xlab("Kwantyl Empiryczny") + 
  ggtitle("Wykres QQ dla cen sprzedaży") + theme(axis.text.x = element_blank(), axis.text.y = element_blank()) ;
```


```{r}
fuelType = database %>% group_by(database$RodzajPaliwa) %>% summarise(liczba = n());
colnames(fuelType) = c("FuelType", "Count");
fuelType

ggplot(fuelType, aes(x="", y=Count, fill=FuelType)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) + theme_void();
  
```
## Liczba koni mechanicznych samochodu

```{r}
summarise(database,
  srednia = mean(KM),
  mediana = median(KM),
  wariancja = var(KM),
  odchylenieStd = sd(KM),
  max = max(KM),
  min = min(KM),
)

ggplot(data=database)+ geom_histogram(aes(x=KM), binwidth = 20) + ggtitle("Histogram dla KM")
```
